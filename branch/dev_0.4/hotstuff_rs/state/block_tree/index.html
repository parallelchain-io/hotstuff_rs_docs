<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Internal read-and-write handle used by the algorithm thread to mutate the Block Tree."><title>hotstuff_rs::state::block_tree - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-492a78a4a87dcc01.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="hotstuff_rs" data-themes="" data-resource-suffix="" data-rustdoc-version="1.82.0 (f6e511eec 2024-10-15)" data-channel="1.82.0" data-search-js="search-a99f1315e7cc5121.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-921df33f47b8780c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-3b12f09e550e0385.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../hotstuff_rs/index.html">hotstuff_<wbr>rs</a><span class="version">0.4.0</span></h2></div><h2 class="location"><a href="#">Module block_<wbr>tree</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section><h2><a href="../index.html">In hotstuff_<wbr>rs::<wbr>state</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">hotstuff_rs</a>::<wbr><a href="../index.html">state</a>::<wbr><a class="mod" href="#">block_tree</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../../src/hotstuff_rs/state/block_tree.rs.html#6-822">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Internal read-and-write handle used by the algorithm thread to mutate the Block Tree.</p>
<p>The Block Tree may be stored in any key-value store of the library user’s own choosing, as long as that
KV store can provide a type that implements <a href="../kv_store/trait.KVStore.html" title="trait hotstuff_rs::state::kv_store::KVStore"><code>KVStore</code></a>. This state can be mutated through an instance
of <a href="struct.BlockTree.html" title="struct hotstuff_rs::state::block_tree::BlockTree"><code>BlockTree</code></a>, and read through an instance of <a href="../block_tree_snapshot/struct.BlockTreeSnapshot.html" title="struct hotstuff_rs::state::block_tree_snapshot::BlockTreeSnapshot"><code>BlockTreeSnapshot</code></a>, which can be created using
<a href="../block_tree_snapshot/struct.BlockTreeCamera.html" title="struct hotstuff_rs::state::block_tree_snapshot::BlockTreeCamera"><code>BlockTreeCamera</code></a>.</p>
<h2 id="mutating-the-block-tree-directly-from-user-code"><a class="doc-anchor" href="#mutating-the-block-tree-directly-from-user-code">§</a>Mutating the Block Tree directly from user code</h2>
<p>In normal operation, HotStuff-rs code will internally be making all writes to the <code>BlockTree</code>, while
users can get a <code>BlockTreeCamera</code> through which they can read from the block tree by calling replica’s
<a href="../../replica/struct.Replica.html#method.block_tree_camera" title="method hotstuff_rs::replica::Replica::block_tree_camera"><code>block_tree_camera</code></a> method.</p>
<p>Sometimes, however, users may want to manually mutate the Block Tree, for example, to recover from
an error that has corrupted some of its invariants. For this purpose, one can unsafe-ly get an
instance of BlockTree using <a href="struct.BlockTree.html#method.new_unsafe" title="associated function hotstuff_rs::state::block_tree::BlockTree::new_unsafe"><code>BlockTree::new_unsafe</code></a> and an instance of the corresponding
<a href="../write_batch/struct.BlockTreeWriteBatch.html" title="struct hotstuff_rs::state::write_batch::BlockTreeWriteBatch"><code>BlockTreeWriteBatch</code></a> using <a href="../write_batch/struct.BlockTreeWriteBatch.html#method.new_unsafe" title="associated function hotstuff_rs::state::write_batch::BlockTreeWriteBatch::new_unsafe"><code>BlockTreeWriteBatch::new_unsafe</code></a>.</p>
<h2 id="state-variables"><a class="doc-anchor" href="#state-variables">§</a>State variables</h2>
<p>HotStuff-rs structures its state into 17 separate conceptual “variables” that are stored in tuples
that sit at <a href="../paths/index.html" title="mod hotstuff_rs::state::paths">specific key paths</a> in the library user’s chosen
KV store. These 17 variables are listed below, grouped into 4 categories for ease of understanding:</p>
<h3 id="blocks"><a class="doc-anchor" href="#blocks">§</a>Blocks</h3><div><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>Blocks</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a> -&gt; <a href="../../types/block/struct.Block.html" title="struct hotstuff_rs::types::block::Block"><code>Block</code></a></td><td>Mapping between a block’s hash and the block itself. This mapping contains all blocks that have been inserted into the block tree, excluding blocks that have been pruned.</td></tr>
<tr><td>Block at Height</td><td><a href="../../types/data_types/struct.BlockHeight.html" title="struct hotstuff_rs::types::data_types::BlockHeight"><code>BlockHeight</code></a> -&gt; <a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a></td><td>Mapping between a block’s height and its block hash. This mapping only contains blocks that are committed, because if a block hasn’t been committed, there may be multiple blocks at the same height.</td></tr>
<tr><td>Block to Children</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a> -&gt; <a href="../../types/data_types/struct.ChildrenList.html" title="struct hotstuff_rs::types::data_types::ChildrenList"><code>ChildrenList</code></a></td><td>Mapping between a block’s hash and the list of children it has in the block tree. A block may have multiple children if they have not been committed.</td></tr>
</tbody></table>
</div><h3 id="app-state"><a class="doc-anchor" href="#app-state">§</a>App State</h3><div><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>Committed App State</td><td><a href="https://doc.rust-lang.org/1.82.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec"><code>Vec&lt;u8&gt;</code></a> -&gt; <a href="https://doc.rust-lang.org/1.82.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec"><code>Vec&lt;u8&gt;</code></a></td><td>All key value pairs in the current committed app state. Produced by applying all app state updates in sequence from the genesis block up to the highest committed block.</td></tr>
<tr><td>Pending App State Updates</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a> -&gt; <a href="../../types/update_sets/type.AppStateUpdates.html" title="type hotstuff_rs::types::update_sets::AppStateUpdates"><code>AppStateUpdates</code></a></td><td>Mapping between a block’s hash and its app state updates. This is empty for an existing block if at least one of the following two cases is true: <ol><li>The block does not update the app state.</li> <li>The block has been committed.</li></ol></td></tr>
</tbody></table>
</div><h3 id="validator-set"><a class="doc-anchor" href="#validator-set">§</a>Validator Set</h3><div><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>Committed Validator Set</td><td><a href="../../types/validator_set/struct.ValidatorSet.html" title="struct hotstuff_rs::types::validator_set::ValidatorSet"><code>ValidatorSet</code></a></td><td>The current committed validator set. Produced by applying all validator set updates in sequence from the genesis block up to the highest committed block.</td></tr>
<tr><td>Previous Validator Set</td><td><a href="../../types/validator_set/struct.ValidatorSet.html" title="struct hotstuff_rs::types::validator_set::ValidatorSet"><code>ValidatorSet</code></a></td><td>The committed validator set before the latest validator set update was committed. <br/><br/>Until a validator set update is considered “decided” (as indicated by the next variable), the previous validator set remains “active”. That is, leaders will continue broadcasting nudges for the previous validator set and replicas will continue voting for such nudges.</td></tr>
<tr><td>Validator Set Update Decided</td><td><a href="https://doc.rust-lang.org/1.82.0/std/primitive.bool.html" title="primitive bool"><code>bool</code></a></td><td>A flag that indicates the most recently committed validator set update has been decided.</td></tr>
<tr><td>Validator Set Update Block Height</td><td><a href="../../types/data_types/struct.BlockHeight.html" title="struct hotstuff_rs::types::data_types::BlockHeight"><code>BlockHeight</code></a></td><td>The height of the block that caused the most recent committed (but perhaps not decided) validator set update.</td></tr>
<tr><td>Validator Set Updates Status</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a> -&gt; <a href="../../types/validator_set/enum.ValidatorSetUpdatesStatus.html" title="enum hotstuff_rs::types::validator_set::ValidatorSetUpdatesStatus"><code>ValidatorSetUpdatesStatus</code></a></td><td>Mapping between a block’s hash and its validator set updates. <br/><br/>Unlike <a href="#app-state">pending app state updates</a>, this is an enum, and distinguishes between the case where the block does not update the validator set and the case where the block updates the validator set but has been committed.</td></tr>
</tbody></table>
</div><h3 id="safety"><a class="doc-anchor" href="#safety">§</a>Safety</h3><div><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>Locked Phase Certificate</td><td><a href="../../hotstuff/types/struct.PhaseCertificate.html" title="struct hotstuff_rs::hotstuff::types::PhaseCertificate"><code>PhaseCertificate</code></a></td><td>The currently locked PC. <a href="../invariants/index.html#locking" title="mod hotstuff_rs::state::invariants">Read more</a></td></tr>
<tr><td>Highest View Phase-Voted</td><td><a href="../../types/data_types/struct.ViewNumber.html" title="struct hotstuff_rs::types::data_types::ViewNumber"><code>ViewNumber</code></a></td><td>The highest view that this validator has phase-voted in.</td></tr>
<tr><td>Highest View Entered</td><td><a href="../../types/data_types/struct.ViewNumber.html" title="struct hotstuff_rs::types::data_types::ViewNumber"><code>ViewNumber</code></a></td><td>The highest view that this validator has entered.</td></tr>
<tr><td>Highest Phase Certificate</td><td><a href="../../hotstuff/types/struct.PhaseCertificate.html" title="struct hotstuff_rs::hotstuff::types::PhaseCertificate"><code>PhaseCertificate</code></a></td><td>Among the phase certificates this validator has seen and verified, the one with the highest view number.</td></tr>
<tr><td>Highest Timeout Certificate</td><td><a href="../../pacemaker/types/struct.TimeoutCertificate.html" title="struct hotstuff_rs::pacemaker::types::TimeoutCertificate"><code>TimeoutCertificate</code></a></td><td>Among the timeout certificates this validator has seen and verified, the one with the highest view number.</td></tr>
<tr><td>Highest Committed Block</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a></td><td>The hash of the committed block that has the highest height.</td></tr>
<tr><td>Newest Block</td><td><a href="../../types/data_types/struct.CryptoHash.html" title="struct hotstuff_rs::types::data_types::CryptoHash"><code>CryptoHash</code></a></td><td>The hash of the most recent block to be inserted into the block tree.</td></tr>
</tbody></table>
</div><h3 id="persistence-in-kv-store"><a class="doc-anchor" href="#persistence-in-kv-store">§</a>Persistence in KV Store</h3>
<p>The location of each of these variables in a KV store is defined in <a href="../paths/index.html" title="mod hotstuff_rs::state::paths">paths</a>.
Note that the fields of a block are itself stored in different tuples. This is so that user code
can get a subset of a block’s data without loading the entire block from storage (which can be
expensive). The key suffixes on which each of block’s fields are stored are also defined in paths.</p>
<h2 id="initial-state"><a class="doc-anchor" href="#initial-state">§</a>Initial state</h2>
<p>All variables in the Block Tree start out empty except eight. These eight variables, which must be
initialized using the <a href="struct.BlockTree.html#method.initialize" title="method hotstuff_rs::state::block_tree::BlockTree::initialize"><code>initialize</code></a> function before doing anything else with
the Block Tree, are:</p>
<div><table><thead><tr><th>Variable</th><th>Initial value</th></tr></thead><tbody>
<tr><td>Committed App State</td><td>Provided to <a href="../../replica/struct.Replica.html#method.initialize" title="associated function hotstuff_rs::replica::Replica::initialize"><code>initialize</code></a>.</td></tr>
<tr><td>Committed Validator Set</td><td>Provided to <a href="../../replica/struct.Replica.html#method.initialize" title="associated function hotstuff_rs::replica::Replica::initialize"><code>initialize</code></a>.</td></tr>
<tr><td>Previous Validator Set</td><td>Provided to <a href="../../replica/struct.Replica.html#method.initialize" title="associated function hotstuff_rs::replica::Replica::initialize"><code>initialize</code></a>.</td></tr>
<tr><td>Validator Set Update Block Height</td><td>Provided to <a href="../../replica/struct.Replica.html#method.initialize" title="associated function hotstuff_rs::replica::Replica::initialize"><code>initialize</code></a>.</td></tr>
<tr><td>Validator Set Update Complete</td><td>Provided to <a href="../../replica/struct.Replica.html#method.initialize" title="associated function hotstuff_rs::replica::Replica::initialize"><code>initialize</code></a>.</td></tr>
<tr><td>Locked PC</td><td>The <a href="../../hotstuff/types/struct.PhaseCertificate.html#method.genesis_pc" title="associated function hotstuff_rs::hotstuff::types::PhaseCertificate::genesis_pc">Genesis PC</a></td></tr>
<tr><td>Highest View Entered</td><td>0</td></tr>
<tr><td>Highest Phase Certificate</td><td>The <a href="../../hotstuff/types/struct.PhaseCertificate.html#method.genesis_pc" title="associated function hotstuff_rs::hotstuff::types::PhaseCertificate::genesis_pc">Genesis PC</a></td></tr>
</tbody></table>
</div></div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BlockTree.html" title="struct hotstuff_rs::state::block_tree::BlockTree">Block<wbr>Tree</a></div><div class="desc docblock-short">Read and write handle into the block tree that should be owned exclusively by the algorithm thread.</div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.BlockTreeError.html" title="enum hotstuff_rs::state::block_tree::BlockTreeError">Block<wbr>Tree<wbr>Error</a></div><div class="desc docblock-short">Errors that may be encountered when reading or writing to the <a href="struct.BlockTree.html" title="struct hotstuff_rs::state::block_tree::BlockTree"><code>BlockTree</code></a>.</div></li></ul></section></div></main></body></html>